{% extends "base.html" %}

{% load humanize %}

{% block extra_meta %}
<meta property="og:title" content="{{ workspace.name }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{ request.build_absolute_uri }}" />
<meta property="og:description" content="Repo: {{ workspace.repo_name }} ({{ workspace.branch }})" />
{% endblock extra_meta %}

{% block content %}

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">

    <li class="breadcrumb-item"><a href="/">Home</a></li>

    <li class="breadcrumb-item">
      <a href="{{ workspace.project.org.get_absolute_url }}">
        {{ workspace.project.org.name }}
      </a>
    </li>

    <li class="breadcrumb-item">
      <a href="{{ workspace.project.get_absolute_url }}">
        {{ workspace.project.name }}
      </a>
    </li>

    <li class="breadcrumb-item active" aria-current="page">{{ workspace.name }}</li>

  </ol>
</nav>

{% if workspace.is_archived %}
<div class="alert alert-warning text-center mb-3" role="warning">
  This Workspace has been archived.  Logs are still available but new Jobs can
  no longer be requested.  If you think this has been done in error, please
  contact an <a href="mailto:team@opensafely.org">admin</a>.
</div>
{% endif %}

<div class="row">
  <div class="col-lg-8 offset-lg-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>{{ workspace.name }}</h3>

      <div class="d-flex">

        {% if user_can_run_jobs %}
        <a class="btn btn-primary mr-2" href="{{ workspace.get_jobs_url }}">Run Jobs</a>
        {% endif %}

        <a class="btn btn-primary mr-2" href="{{ workspace.get_logs_url }}">Logs</a>

      </div>
    </div>

    <p>
      This is an OpenSAFELY workspace.  It represents a working directory for the
      <a href="{{ workspace.project.get_absolute_url }}">{{ workspace.project.name }}</a>
      project on all of the secure services ("backends") supported by
      OpenSAFELY.  On each backend, the directory includes code from the
      <a href="{{ workspace.repo }}">repository</a>,
      and the results of running it against real data ("jobs"). Researchers can
      request jobs are run from this page.
    </p>

    <div id="details">

      <div class="d-flex">
        {% if can_use_releases %}

        {% if user_can_view_files %}
        <a class="btn btn-primary mr-2" href="{{ workspace.get_files_url }}">Level 4 Outputs</a>
        {% endif %}

        {% if user_can_view_releases %}
        <a class="btn btn-primary mr-2" href="{{ workspace.get_releases_url }}">Released Outputs</a>
        {% endif %}

        {% if user_can_view_outputs %}
        <a class="btn btn-primary mr-2" href="{{ workspace.get_outputs_url }}">Published Outputs</a>
        {% endif %}

        {% endif %}
      </div>

      <div class="row">

        <div class="col-lg-9">
          <p>
            <strong>Repo:</strong>
            <a href="{{ workspace.repo }}">{{ workspace.repo_name }}</a>
            <span class="badge badge-secondary">
              {% if repo_is_private %}Private{% else %}Public{% endif %}
            </span>
          </p>

          <p><strong>Branch:</strong> {{ workspace.branch }}</p>

          <p><strong>DB:</strong> {{ workspace.db }}</p>

           <p>
             <strong>Created:</strong>
             <span title="{{ workspace.created_at|date:"Y-m-d H:i:s" }}">
               {{ workspace.created_at|naturaltime }}
             </span>
           </p>

          {% if workspace.created_by %}
          <p><strong>Created By:</strong> {{ workspace.created_by.name }}</p>
          {% endif %}
        </div>

        <div class="col-lg-3 text-right">
          {% if user_can_run_jobs %}
          <form method="POST" action="{{ workspace.get_archive_toggle_url }}" class="my-2">
            {% csrf_token %}

            <input type="hidden" name="is_archived" value="{{ workspace.is_archived|yesno:",True" }}" />

            <button class="btn btn-danger" type="submit">
              {% if not workspace.is_archived %}
              Archive
              {% else %}
              Unarchive
              {% endif %}
            </button>
          </form>

          <form method="POST" class="mb-2" action="{{ workspace.get_notifications_toggle_url }}">
            {% csrf_token %}

            <input type="hidden" name="should_notify" value="{{ workspace.should_notify|yesno:",True" }}" />

            <button class="btn btn-success" type="submit">
              Turn Notifications {% if workspace.should_notify %}Off{% else %}On{% endif %}
            </button>
          </form>
          {% endif %}
        </div>

      </div>
    </div>

  </div>
</div>

{% endblock content %}
