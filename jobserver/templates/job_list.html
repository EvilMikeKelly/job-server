{% extends "base.html" %}

{% load humanize %}
{% load querystring_tools %}
{% load runtime %}
{% load selected_filter %}
{% load static %}
{% load status_tools %}

{% block content %}

<div class="job-list">
  <div class="d-flex justify-content-between mt-3 mb-4">

    <h2>Jobs</h2>

    {% if user.is_authenticated %}
    <div>
      <a class="btn btn-primary" href="{% url 'job-select-workspace' %}">
        Add Job
      </a>
    </div>
    {% endif %}

  </div>

  <div class="row">

    <div class="col-lg-10">

    <form class="form d-flex align-items-center mb-4" method="GET">
      <input
        class="form-control mr-2"
        type="search"
        placeholder="Search action_id or job_id"
        aria-label="Search"
        name="q" />
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>


      {% if not object_list %}
      <div class="text-center">
        <p>No results found.</p>
        <a href="{% url 'job-list' %}">Clear all filters?</a>
      </div>
      {% else %}

      <div class="job-requests">
        <div class="d-flex">
          <div class="status"></div>
          <div class="workspace"><strong>Workspace</strong></div>
          <div class="job-count"><strong>Jobs</strong></div>
          <div class="action"><strong>Requested Action</strong></div>
          <div class="started-at"><strong>Started</strong></div>
          <div class="runtime"><strong>Runtime</strong></div>
        </div>

        {% for group in object_list %}
        <div class="job-request">
          <div class="d-flex align-items-center py-2">
            <div class="status">{% status_icon group.status %}</div>
            <div class="workspace">{{ group.workspace.name }}</div>
            <div class="job-count">{{ group.num_completed }}/{{ group.jobs.all|length }}</div>
            <div class="action text-truncate" title="group.requested_action">
              {{ group.requested_action }}
            </div>
            <div class="started-at">{{ group.started_at|naturaltime|default_if_none:"-" }}</div>
            <div class="runtime">{% runtime group.runtime %}</div>
            <div class="mx-2">
              <button
                class="btn btn-sm btn-primary"
                {% if not group.jobs.exists %}
                disabled
                {% endif %}
                type="button"
                data-toggle="collapse"
                data-target="#group-{{ group.pk }}"
                aria-expanded="false"
                aria-controls="group-{{ group.pk }}"
                >
                Show/Hide Individual Jobs
              </button>
            </div>
          </div>

          {% if group.jobs.exists %}
          <div id="group-{{ group.pk }}" class="jobs collapse">
            <div class="grid">
              <span class="pl-3"></span>
              <span class="d-none d-lg-inline"><strong>ID</strong></span>
              <span><strong>Action</strong></span>
              <span><strong>Runtime</strong></span>
              <span class="d-none d-lg-inline"><strong>Status Message</strong></span>
              <span></span>

              {% for job in group.ordered_jobs %}
              <span class="pl-3">{% status_icon job.status %}</span>
              <span class="d-none d-lg-inline"><small>{{ job.pk }}</small></span>
              <span>{{ job.action_id }}</span>
              <span {% if job.started_at %} title="{{ job.started_at|naturaltime }}"{% endif %}>
                <small>{% runtime job.runtime %}</small>
              </span>
              <span class="d-none d-lg-inline text-truncate" title="{{ job.status_message }}">
                {{ job.status_message|default:"-" }}
              </span>
              <span>
                <a class="btn btn-sm btn-secondary text-white" href="{% url 'jobs-detail' pk=job.pk %}">
                  View
                </a>
              </span>
              {% endfor %}
            </div>

          </div>
          {% endif %}

        </div>
        {% endfor %}  {# end of object_list loop #}

      </div>

      <div class="d-flex justify-content-between my-3">

        <div>
          <span class="{% if not page_obj.has_previous %}d-none{% endif %}">
            {% if page_obj.has_previous %}
            <a class="btn btn-secondary btn-sm" href="{% url_with_querystring page=page_obj.previous_page_number %}">
              Previous
            </a>
            {% endif %}
          </span>
        </div>

        <div class="current">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </div>

        <div>
          <span class="{% if not page_obj.has_next %}d-none{% endif %}">
            {% if page_obj.has_next %}
            <a class="btn btn-secondary btn-sm" href="{% url_with_querystring page=page_obj.next_page_number %}">
              Next
            </a>
            {% endif %}
          </span>
        </div>

      </div>
      {% endif %}
    </div>

    <div class="col-lg-2 filters">
      <h4>Filters</h4>

      {% if request.GET %}
      <div class="mb-3">
        <a href="{% url 'job-list' %}">Clear All</a>
      </div>
      {% endif %}

      <h5>Status</h5>
      <ul class="list-group list-unstyled mb-4">
        {% for status in statuses %}
        {% is_filter_selected key="status" value=status as is_active %}
        <li class="list-group-item {% if is_active %} active{% endif %}">

          <a href="{% url_with_querystring status=status %}">{{ status }}</a>

          {% if is_active %}
          <a
            type="button"
            class="close"
            aria-label="Close"
            href="{% url_without_querystring status=status %}"
            >
            <span aria-hidden="true">&times;</span>
          </a>
          {% endif %}

        </li>
        {% endfor %}
      </ul>

      <h5>Workspaces</h5>
      <ul class="list-group list-unstyled">
        {% for workspace in workspaces %}
        {% is_filter_selected key="workspace" value=workspace.pk as is_active %}
        <li class="list-group-item list-group-item-action{% if is_active %} active{% endif %}">

          <a href="{% url_with_querystring workspace=workspace.pk %}">{{ workspace.name }}</a>

          {% if is_active %}
          <a
            type="button"
            class="close"
            aria-label="Close"
            href="{% url_without_querystring workspace=workspace.pk %}"
            >
            <span aria-hidden="true">&times;</span>
          </a>
          {% endif %}

        </li>
        {% endfor %}
      </div>

    </div>

  </div>

</div>
{% endblock content %}
