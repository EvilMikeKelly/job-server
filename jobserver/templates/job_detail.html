{% extends "base.html" %}

{% load humanize %}
{% load runtime %}
{% load status_tools %}

{% block extra_meta %}
<meta property="og:title" content="Action: {{ job.action }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{ request.build_absolute_uri }}" />
<meta property="og:description" content="Workspace: {{ job.job_request.workspace.name }}" />
{% endblock extra_meta %}

{% block content %}

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">

    <li class="breadcrumb-item"><a href="/">Home</a></li>

    <li class="breadcrumb-item">
      <a href="{{ job.job_request.workspace.project.org.get_absolute_url }}">
        {{ job.job_request.workspace.project.org.name }}
      </a>
    </li>

    <li class="breadcrumb-item">
      <a href="{{ job.job_request.workspace.project.get_absolute_url }}">
        {{ job.job_request.workspace.project.name }}
      </a>
    </li>

    <li class="breadcrumb-item">
      <a href="{{ job.job_request.workspace.get_absolute_url }}">
        {{ job.job_request.workspace.name }}
      </a>
    </li>

    <li class="breadcrumb-item">
      <a href="{{ job.job_request.get_absolute_url }}">
        Request {{ job.job_request.id }}
      </a>
    </li>

    <li class="breadcrumb-item active" aria-current="page">{{ job.action }}</li>

  </ol>
</nav>

<div class="row">

  <div class="col-md-9 col-lg-6 offset-lg-2">

    <h2><code>{{ job.action }}</code></h2>
    <p class="small text-muted">
      ID: {{ job.identifier }}
    </p>

    <p>
      This page describes a "job", an action ({{ job.action }}) requested by the
      user, and run on a secure backend ({{ job.job_request.backend.name }}).
    </p>

    <div class="mb-4">
      <h3>State</h3>

      {% if job.action in job.job_request.cancelled_actions %}
      <div class="alert alert-danger" role="alert">
        A User has requested this Job is cancelled.
      </div>
      {% endif %}

      <div>
        <strong>Status:</strong>
        <code>{{ job.status }}</code>
      </div>

      <div>
        <strong>Status Message:</strong>
        {% if job.status_message %}
        <pre class="text-wrap">{{ job.status_message }}</pre>
        {% else %}-{% endif %}

        {% status_hint job %}
      </div>

    </div>

    <div class="mb-4">
      <h3>Config</h3>

      <div>
        <strong>Backend:</strong>
        <code>{{ job.job_request.backend }}</code>
      </div>

      <div>
        <strong>Workspace:</strong>
        <a href="{{ job.job_request.workspace.get_absolute_url }}">
          {{ job.job_request.workspace.name }}
        </a>
        <small class="text-muted">({{ job.job_request.workspace.branch }})</small>
      </div>

      {% if job.job_request_id %}
      <div>
        <strong>Request:</strong>
        <a href="{{ job.job_request.get_absolute_url }}">
          {{ job.job_request_id }} by {{ job.job_request.created_by.username }}
        </a>
      </div>
      {% endif %}

    </div>

    <div class="mb-4">
      <h3>Timings</h3>

      <p>
        The timestamps below are generated and stored using the
        <a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>
        timezone on the secure backend which created this job,
        {{ job.job_request.backend.name }}.
      </p>

      <div class="mb-2">
        <strong>Created:</strong>
        <span title="{{ job.created_at|date:"Y-m-d H:i:sO" }}">
          {{ job.created_at|naturaltime }}
        </span>
        <br />
        <small class="text-muted">When the job was created by the secure backend.</small>
      </div>

      <div class="mb-2">
        <strong>Acknowledged:</strong>
        <span title="{{ job.started_at|date:"Y-m-d H:i:sO"|default_if_none:"" }}">
          {{ job.started_at|naturaltime|default_if_none:"-" }}
        </span>
        <br />
        <small class="text-muted">
          When the job moved to the pending or running state on the secure backend.
        </small>
      </div>

      <div class="mb-2">
        <strong>Finished:</strong>
        <span title="{{ job.completed_at|date:"Y-m-d H:i:sO"|default_if_none:"" }}">
          {{ job.completed_at|naturaltime|default_if_none:"-"}}
        </span>
        <br />
        <small class="text-muted">
          When the job finished running on the secure backend.
        </small>
      </div>

      <div class="mb-2">
        <strong>Duration:</strong> <span>{% runtime job.runtime %}</span>
        <br />
        <small class="text-muted">
          How long the job ran for on the secure backend, this includes time
          spent copying files, and waiting to be checked by the backend.
        </small>
      </div>

      <div class="mb-2">
        <strong>Last Updated by Backend:</strong>
        <span title="{{ job.updated_at|date:"Y-m-d H:i:sO"|default_if_none:"" }}">
          {{ job.updated_at|naturaltime|default_if_none:"-" }}
        </span>

        <br />
        <small class="text-muted">
          How long ago did the secure backend update the website about this
          job.
        </small>

        {% if job.is_missing_updates %}
        <div>
          ⚠️
          <small class="text-muted">
            This Job has not been updated for over 30 minutes, some of the data
            on this page could be stale.
          </small>
        </div>
        {% endif %}
      </div>
    </div>

  </div>

  <div class="col-md-3 col-lg-2">

    {% if user_can_cancel_jobs %}
    <h3 class="text-center">Tools</h3>

    <form class="mb-3" method="POST" action="{{ job.get_cancel_url }}">
      {% csrf_token %}

      <button
        class="btn btn-block btn-danger"
        {% if job.is_completed or job.action in job.job_request.cancelled_actions %}
        disabled
        {% endif %}
        type="submit">
        Cancel
      </button>
    </form>

    {% endif %}

  </div>

</div>
{% endblock content %}
