{% extends "base-tw.html" %}

{% load humanize %}
{% load status_tools %}

{% block extra_meta %}
<meta property="og:title" content="Action: {{ job.action }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{ request.build_absolute_uri }}" />
<meta property="og:description" content="Workspace: {{ job.job_request.workspace.name }}" />
{% endblock extra_meta %}

{% block metatitle %}Job request: {{ job.action }} - {{ job.job_request.id }} - {{ job.job_request.workspace.name }} | OpenSAFELY Jobs{% endblock metatitle %}

{% block breadcrumbs %}
  {% url 'home' as home_url %}
  {% include "_components/breadcrumb.html" with title="Home" url=home_url %}
  {% include "_components/breadcrumb.html" with location="Organisation" truncate=True title=job.job_request.workspace.project.org.name url=job.job_request.workspace.project.org.get_absolute_url %}
  {% include "_components/breadcrumb.html" with location="Project" truncate=True title=job.job_request.workspace.project.title url=job.job_request.workspace.project.get_absolute_url %}
  {% include "_components/breadcrumb.html" with location="Workspace" truncate=True title=job.job_request.workspace.name url=job.job_request.workspace.get_absolute_url %}
  {% include "_components/breadcrumb.html" with location="Job request" title=job.job_request.id url=job.job_request.get_absolute_url %}
  {% include "_components/breadcrumb.html" with location="Action" title=job.action active=True %}
{% endblock breadcrumbs %}

{% block content %}
<div class="md:flex md:items-center md:justify-between md:space-x-5">
  <h1 class="text-3xl break-all md:bread-words md:text-4xl font-bold text-slate-900">
    {{ job.action }}
  </h1>
  <div class="mt-6 flex flex-col-reverse justify-stretch space-y-4 space-y-reverse sm:flex-row-reverse sm:justify-end sm:space-x-reverse sm:space-y-0 sm:space-x-3 md:mt-0 md:flex-row md:space-x-3">
    {% if user_can_cancel_jobs %}
      <form class="d-inline-block" method="POST" action="{{ job.get_cancel_url }}">
        {% csrf_token %}
          {% if job.is_completed or job.action in job.job_request.cancelled_actions %}
            {% include "_components/button.html" with type="submit" disabled=True tooltip="This job can no longer be cancelled" content="Cancel "|add:job.action only %}
          {% else %}
            {% include "_components/button.html" with type="submit" variant="danger" content="Cancel "|add:job.action only %}
          {% endif %}
      </form>
    {% endif %}
  </div>
</div>

{% if job.is_missing_updates %}
<div class="rounded-md bg-bn-flamenco-100 shadow p-4 mt-4">
  <div class="flex">
    <div class="flex-shrink-0">
      {% include "_icons/exclamation-solid.svg" with class="h-7 w-7 text-bn-flamenco-400" only %}
    </div>
    <div class="ml-3">
      <h2 class="font-bold text-lg tracking-tight text-bn-flamenco-900">Attention needed</h3>
      <div class="mt-1 text-bn-flamenco-800">
        <p>This Job has not been updated for over 30 minutes, some of the data on this page could be stale.</p>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="mt-8 grid grid-cols-1 gap-6 lg:grid-flow-col-dense lg:grid-cols-3">
  <section aria-labelledby="timeline-title" class="lg:col-start-1 lg:col-span-1">
    <div class="bg-white shadow sm:rounded-lg overflow-hidden">
      <h2 id="timeline-title" class="text-lg font-semibold text-slate-900 px-4 py-2 sm:px-6 sm:py-3">Timeline</h2>
      <ul class="flow-root px-4 py-2 sm:px-6 sm:py-5 border-t border-slate-200 -mb-8">
        {% include "_components/timeline-item.html" with background="blue" title="Created by the secure backend:" icon="pencil-outline" job_time=job.created_at only %}
        {% include "_components/timeline-item.html" with background="purple" title="Moved to the pending or running state on the secure backend:" icon="folder-open-outline" job_time=job.started_at only %}
        {% include "_components/timeline-item.html" with background="green" title="Finished running on the secure backend:" icon="check-outline" job_time=job.completed_at only %}
        {% include "_components/timeline-item.html" with background="yellow" title="Time spent running on the secure backend:" icon="clock-outline" content=job.runtime only %}
        {% include "_components/timeline-item.html" with background="pink" title="Last update by secure backend:" icon="status-online-outline" job_time=job.updated_at last=True only %}
      </ul>

      <p class="bg-slate-50 text-sm font-medium text-slate-600 px-4 py-2 sm:px-6 sm:py-4">
        These timestamps are generated and stored using the UTC timezone on the {{ job.job_request.backend|upper }} secure backend.
      </p>
    </div>
  </section>

  <div class="space-y-6 md:space-y-6 lg:col-start-2 lg:col-span-2">
    <section aria-labelledby="job-information-title" class="bg-white shadow sm:rounded-lg">
      <h2 id="job-information-title" class="text-lg font-semibold text-slate-900 px-4 py-2 sm:px-6 sm:py-3">Job information</h2>
      <dl class="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2 px-4 py-2 sm:px-6 sm:py-5 border-t border-slate-200">
        <div class="sm:col-span-1">
          <dt class="text-sm font-semibold text-slate-600">Job identifier</dt>
          <dd class="mt-1 text-sm text-slate-900">{{ job.identifier }}</dd>
        </div>
        <div class="sm:col-span-1">
          <dt class="text-sm font-semibold text-slate-600">Job request</dt>
          <dd class="mt-1 text-sm text-slate-900">{{ job.job_request_id }}</dd>
        </div>
        <div class="sm:col-span-1">
          <dt class="text-sm font-semibold text-slate-600">Requested by</dt>
          <dd class="mt-1 text-sm text-slate-900">{{ job.job_request.created_by.username }}</dd>
        </div>
        <div class="sm:col-span-1">
          <dt class="text-sm font-semibold text-slate-600">Branch</dt>
          <dd class="mt-1 text-sm text-slate-900">{{ job.job_request.workspace.branch }}</dd>
        </div>
        <div class="sm:col-span-1">
          <dt class="text-sm font-semibold text-slate-600">Backend</dt>
          <dd class="mt-1 text-sm text-slate-900">{{ job.job_request.backend }}</dd>
        </div>
        <div class="sm:col-span-1">
          <dt class="text-sm font-semibold text-slate-600">Status</dt>
          <dd class="mt-1 text-sm text-slate-900">{{ job.status|capfirst }}</dd>
        </div>
        <div class="sm:col-span-2">
          <dt class="text-sm font-semibold text-slate-600">Status message</dt>
          <dd class="mt-1 text-sm text-slate-900">
            {% if job.status_message %}
              {{ job.status_message }}
            {% else %}
              -
            {% endif %}
            {% if job.action in job.job_request.cancelled_actions %}
              <p>A User has requested this Job is cancelled.</p>
            {% endif %}
            {% status_hint job %}
          </dd>
        </div>
      </dl>
    </section>

    {% if honeycomb_can_view_links %}
    <section aria-labelledby="monitoring-title" class="bg-white shadow sm:rounded-lg overflow-hidden">
      <div class="px-4 py-2 sm:px-6 sm:py-3">
        <h2 id="monitoring-title" class="text-lg font-semibold text-slate-900">
          Monitoring
        </h2>
        <p class="text-slate-600 text-sm">Honeycomb login required</p>
      </div>
      <ul class="flow-root px-4 py-2 sm:px-6 sm:py-5 border-t border-slate-200 list-disc text-sm">
        <li class="ml-4">
          {% include "_components/link.html" with href="https://ui.honeycomb.io/bennett-institute-for-applied-data-science/environments/production/datasets/job-server?query=%7B%22start_time%22%3A{{ honeycomb_context_starttime|date:'U'|default_if_none:'1646312416' }}%2C%22end_time%22%3A{{ honeycomb_context_endtime|date:'U' }}%2C%22granularity%22%3A0%2C%22breakdowns%22%3A%5B%22status%22%5D%2C%22calculations%22%3A%5B%7B%22op%22%3A%22COUNT%22%7D%5D%2C%22filters%22%3A%5B%7B%22column%22%3A%22name%22%2C%22op%22%3A%22%3D%22%2C%22value%22%3A%22update_job%22%7D,%7B%22column%22%3A%22job_identifier%22%2C%22op%22%3A%22%3D%22%2C%22value%22%3A%22{{ job.identifier }}%22%7D%5D%2C%22filter_combination%22%3A%22AND%22%2C%22orders%22%3A%5B%7B%22op%22%3A%22COUNT%22%2C%22order%22%3A%22descending%22%7D%5D%2C%22havings%22%3A%5B%5D%2C%22limit%22%3A100%7D" text="All monitoring events for this job" only %}
        </li>
      </ul>
    </section>
    {% endif %}
  </div>
</div>
{% endblock content %}
