# Load .env files by default
set dotenv-load := true


build env="dev":
    #!/usr/bin/env bash

    # set build args for prod builds
    export BUILD_DATE=$(date -u +'%y-%m-%dT%H:%M:%SZ')
    export GITREF=$(git rev-parse --short HEAD)

    # build the thing
    docker-compose build --pull {{ env }}


# run tests in dev container
test *args="": build
    docker-compose run --rm test bash -c "coverage run --branch --source=applications,jobserver,services,staff,tests --module pytest && coverage report || coverage html"


# run server in dev|prod container
serve env="dev" *args="":
    {{ just_executable() }} build {{ env }}
    docker-compose up {{ args }} {{ env }}


# run command in dev|prod container
run env="dev" *args="bash":
    {{ just_executable() }} build {{ env }}
    docker-compose run --rm {{ env }} {{ args }}


# exec command in existing dev|prod container
exec env="dev" *args="bash":
    {{ just_executable() }} build {{ env }}
    docker-compose exec {{ env }} {{ args }}


# run a basic functional smoke test against a running job-server
smoke-test host="http://localhost:8000":
    #!/bin/bash
    set -eu
    curl -I {{ host }} -s --compressed --fail --retry 10 --retry-delay 2 --retry-connrefused
