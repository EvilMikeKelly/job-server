{% extends "base-tw.html" %}

{% load django_vite %}
{% load humanize %}
{% load static %}

{% block metatitle %}{{ analysis_request.project.name }} Analysis | OpenSAFELY Jobs{% endblock metatitle %}

{% block extra_meta %}
<meta name="description" content="{{ analysis_request.project.name }} is an OpenSAFELY project from {{ analysis_request.project.org.name }}. Every time a researcher runs their analytic code against patient data, it is audited in public here.">
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'highlighting.css' %}">
{% endblock extra_styles %}

{% block breadcrumbs %}
  {% url "home" as home_url %}

  {% #breadcrumbs %}
    {% breadcrumb title="Home" url=home_url %}
    {% breadcrumb title=analysis_request.project.org.name url=analysis_request.project.org.get_absolute_url location="Organisation" %}
    {% breadcrumb title=analysis_request.project.name url=analysis_request.project.get_absolute_url location="Project" %}
    {% breadcrumb title="View an analysis" active=True %}
  {% /breadcrumbs %}
{% endblock breadcrumbs %}

{% block content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
  <div class="flex flex-col text-center items-center gap-y-2 lg:text-left lg:items-start lg:col-span-full">
    <div class="flex flex-col items-center gap-y-2 w-full lg:flex-row lg:justify-between lg:items-start">
      <div class="order-2 w-full lg:mr-auto lg:order-1">
        <h1 class="mb-2 text-3xl tracking-tight break-words font-bold text-slate-900 sm:text-4xl">
          {{ analysis_request.title }}
        </h1>
        <dl class="flex flex-col gap-2 text-sm text-slate-600 items-center sm:flex-row sm:gap-x-6 sm:justify-center lg:justify-start">
          <dt class="sr-only">Organisation:</dt>
          <dd class="flex flex-row items-start overflow-hidden">
            {% icon_building_library_outline class="mr-1.5 h-5 w-5 flex-shrink-0 text-slate-400" %}
            <span class="truncate">{{ analysis_request.project.org.name }}</span>
          </dd>
          <dt class="sr-only">Project:</dt>
          <dd class="flex flex-row items-start overflow-hidden">
            {% icon_rectangle_stack_outline class="mr-1.5 h-5 w-5 flex-shrink-0 text-slate-400" %}
            <span class="truncate">{{ analysis_request.project.name }}</span>
          </dd>
        </dl>
      </div>
      {% if user_can_view_staff_area %}
        <div class="order-1 lg:order-2 flex-shrink-0">
          {% #button href=analysis_request.get_staff_url type="link" variant="danger" class="flex-shrink-0" %}
            View in Staff Area
            {% icon_lifebuoy_outline class="h-4 w-4 ml-2 -mr-2" %}
          {% /button %}
        </div>
      {% endif %}
    </div>

    <div class="flex flex-col mt-2 sm:flex-row gap-2 lg:items-start">
      {% if not object.publish_request %}
        {% if not report %}
          {% #button type="button" variant="success" disabled=True tooltip="Report has not been processed" %}
            Publish report
          {% /button %}
        {% else %}
          {% #button type="link" href=analysis_request.get_publish_url variant="success" %}
            Publish report
          {% /button %}
        {% endif %}
      {% else %}
        {% #button type="link" href=object.publish_request.get_absolute_url variant="primary" %}
          View published report
        {% /button %}
      {% endif %}

      {% #button type="link" href=analysis_request.job_request.get_absolute_url variant="secondary" %}
        View job request
      {% /button %}
    </div>
  </div>

  <div class="grid gap-6 place-content-stretch lg:col-span-2">
    {% if report %}
      {% #card title="Report" container=True class="font-lg text-slate-700" %}
        {{ report }}
      {% /card %}
    {% else %}
      {% #card class="lg:col-span-2" %}
        <div class="text-center p-8">
          {% icon_custom_spinner class="h-12 w-12 mb-4 mx-auto flex-1 animate-spin stroke-current stroke-2 text-slate-600" %}
          <h2 class="mt-2 mb-4 text-xl font-semibold text-slate-900">
            Your request is being processed
          </h2>
          <div class="grid gap-y-2 max-w-prose mx-auto">
            <p>
              The results will be checked carefully by our team for privacy and
              security reasons.
            </p>
            <p>
              We aim to process requests within two working days, although it may
              take up to five working days. We are working to improve this for
              the future.
            </p>
            <p class="text-slate-600 pt-4 mt-2 border-t border-slate-200">
              If you'd like any more information about requesting an analysis
              <span class="md:block">
                or have any questions,
                {% link href="mailto:team@opensafely.org" text="contact us" append_after="." %}
              </span>
            </p>
          </div>
        </div>
      {% /card %}
    {% endif %}
  </div>

  <div class="space-y-6 md:space-y-6 lg:col-span-1">
    {% #card title="Analysis Request" %}
      <dl class="border-t border-slate-200 sm:divide-y sm:divide-slate-200">
        {% #description_item stacked=True title="Created at" %}
          {{ analysis_request.created_at }}
          <time datetime='{{ analysis_request.created_at|date:"Y-m-d H:i:sO" }}'></time>
        {% /description_item %}

        {% #description_item stacked=True title="Created by" %}
          {% link href=analysis_request.created_by.get_staff_url text=analysis_request.created_by.fullname %}
        {% /description_item %}
      </dl>
    {% /card %}
  </div>
</div>
{% endblock content %}

{% block extra_js %}
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [
          ["$", "$"],
          ["\\(", "\\)"],
        ],
        displayMath: [
          ["$$", "$$"],
          ["\\[", "\\]"],
        ],
        processEscapes: true,
        processEnvironments: true,
      },
      // Center justify equations in code and markdown cells. Elsewhere
      // we use CSS to left justify single line equations in code cells.
      displayAlign: "center",
      "HTML-CSS": {
        styles: { ".MathJax_Display": { margin: 0 } },
        linebreaks: { automatic: true },
      },
    });
  </script>

  {% vite_asset "assets/src/scripts/analysis-request-detail.js" %}
{% endblock %}
