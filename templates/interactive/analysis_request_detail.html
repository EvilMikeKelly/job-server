{% extends "base-tw.html" %}

{% load django_vite %}
{% load humanize %}
{% load static %}

{% block metatitle %}{{ analysis_request.project.name }} Analysis | OpenSAFELY Jobs{% endblock metatitle %}

{% block extra_meta %}
<meta name="description" content="{{ analysis_request.project.name }} is an OpenSAFELY project from {{ analysis_request.project.org.name }}. Every time a researcher runs their analytic code against patient data, it is audited in public here.">
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'highlighting.css' %}">
{% endblock extra_styles %}

{% block breadcrumbs %}
  {% url "home" as home_url %}

  {% #breadcrumbs %}
    {% breadcrumb title="Home" url=home_url %}
    {% breadcrumb title=analysis_request.project.org.name url=analysis_request.project.org.get_absolute_url location="Organisation" %}
    {% breadcrumb title=analysis_request.project.name url=analysis_request.project.get_absolute_url location="Project" %}
    {% breadcrumb title=analysis_request.title location="Analysis Request" active=True %}
  {% /breadcrumbs %}
{% endblock breadcrumbs %}

{% block content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
  <div class="flex flex-col text-center items-center gap-y-2 lg:text-left lg:items-start lg:col-span-full">
    <div class="flex flex-col items-center gap-y-2 w-full lg:flex-row lg:justify-between lg:items-start">
      <div class="order-2 w-full lg:mr-auto lg:order-1">
        <h1 class="mb-2 text-3xl tracking-tight break-words font-bold text-slate-900 sm:text-4xl">
          {{ analysis_request.title }}
        </h1>
        <dl class="flex flex-col gap-2 text-sm text-slate-600 items-center sm:flex-row sm:gap-x-6 sm:justify-center lg:justify-start">
          <dt class="sr-only">Organisation:</dt>
          <dd class="flex flex-row items-start overflow-hidden">
            {% icon_building_library_outline class="mr-1.5 h-5 w-5 flex-shrink-0 text-slate-400" %}
            <span class="truncate">{{ analysis_request.project.org.name }}</span>
          </dd>
          <dt class="sr-only">Project:</dt>
          <dd class="flex flex-row items-start overflow-hidden">
            {% icon_rectangle_stack_outline class="mr-1.5 h-5 w-5 flex-shrink-0 text-slate-400" %}
            <span class="truncate">{{ analysis_request.project.name }}</span>
          </dd>
        </dl>
      </div>
      {% if user_can_view_staff_area %}
        <div class="order-1 lg:order-2 flex-shrink-0">
          {% #button href=analysis_request.get_staff_url type="link" variant="danger" class="flex-shrink-0" %}
            View in Staff Area
            {% icon_lifebuoy_outline class="h-4 w-4 ml-2 -mr-2" %}
          {% /button %}
        </div>
      {% endif %}
    </div>

    <div class="flex flex-col mt-2 sm:flex-row gap-2 lg:items-start">
      {% if not object.publish_request %}
        {% if report %}
          {% #button type="link" href=analysis_request.get_publish_url variant="success" %}
            Publish report
          {% /button %}
        {% else %}
          {% #button type="button" variant="success" disabled=True tooltip="Report has not been processed" %}
            Publish report
          {% /button %}
        {% endif %}
      {% endif %}

      {% if not report %}
        {% #button type="link" variant="primary" disabled=True tooltip="Report has not been processed" %}
          Update title and summary
        {% /button %}
      {% elif object.publish_request %}
        {% #button type="link" variant="primary" disabled=True tooltip="Cannot edit while publishing review is ongoing" %}
          Update title and summary
        {% /button %}
      {% else %}
        {% #button type="link" variant="primary" href=analysis_request.get_edit_url %}
          Update title and summary
        {% /button %}
      {% endif %}

      {% if report %}
        {% #button type="button" id="downloadBtn" variant="primary" data_title=analysis_request.title %}
          Download report
        {% /button %}
      {% else %}
        {% #button type="button" variant="primary" disabled=True tooltip="Report has not been processed" %}
          Download report
        {% /button %}
      {% endif %}
    </div>
  </div>

  <div class="grid gap-6 lg:col-span-3 xl:grid-cols-6" id="reportContainer">
    {% if report %}
      {% #card title="Request information" class="xl:col-span-4 xl:col-start-2" header_class="sr-only" %}
        <dl class="border-t border-slate-200 sm:divide-y sm:divide-slate-200">
          {% #description_item title="Created at" %}
            <time datetime="{{ analysis_request.created_at|date:"Y-m-d H:i:sO" }}">
              {{ analysis_request.created_at|date:"d M Y H:i:s e" }}
            </time>
          {% /description_item %}

          {% #description_item title="Created by" %}
            {% if user_can_view_staff_area %}
            {% link href=analysis_request.created_by.get_staff_url text=analysis_request.created_by.fullname %}
            {% else %}
            {{ analysis_request.created_by.fullname }}
            {% endif %}
          {% /description_item %}

          {% #description_item title="Purpose" %}
            {{ analysis_request.purpose }}
          {% /description_item %}
        </dl>
      {% /card %}

      {% #card title="Report" container=True class="relative font-lg text-slate-800 xl:col-span-6" header_class="sr-only" %}
        <div id="report">

          <div class="text-base bg-oxford-50 py-6 px-8 mb-6 pdf--hide">
            <p>This report was generated by <strong>{{ analysis_request.created_by.fullname }}</strong> on <strong>{{ analysis_request.created_at|date:"dS F Y" }}</strong> using the <a href="https://www.opensafely.org/interactive/" target="_blank" rel="noopener noreferrer">OpenSAFELY Interactive application</a>.</p>
            <p><strong>This report has not yet been approved for publication and is being shared in confidence.</strong> Recipients must not distribute further unless permitted via the <a href="https://www.opensafely.org/policies-for-researchers/#acknowledgment-and-data-sharing--publication-policy" target="_blank" rel="noopener noreferrer">OpenSAFELY policy on sharing of results</a>.</p>
          </div>

          <section id="editable_header">
            <h1 class="mb-2 text-3xl tracking-tight break-words font-bold text-slate-900 sm:text-4xl">
              {{ analysis_request.report.title }}
            </h1>
            <p class="lead">{{ analysis_request.report.description|linebreaksbr }}</p>
          </section>

          <div class="[&_h1]:hidden" id="interactiveReport">
            {{ report }}
          </div>

          <div class="text-base bg-oxford-50 py-6 px-8 mt-6 pdf--hide">
            <p>Generated using OpenSAFELY Interactive:</p>
            <ul>
              <li>
                <strong>Project:</strong>
                <a href="{{ analysis_request.project.get_absolute_url }}" target="_blank" rel="noopener noreferrer">{{ analysis_request.project.name }}</a>
              </li>
              <li>
                <strong>Report:</strong>
                <a href="{{ analysis_request.get_absolute_url }}" target="_blank" rel="noopener noreferrer">{{ analysis_request.title }}</a>
              </li>
            </ul>
            <p><a href="{{ analysis_request.job_request.get_repo_url }}" target="_blank" rel="noopener noreferrer">All code is shared openly for review and re-use under MIT open license</a></p>
          </div>

          <div id="watermark" class="hidden absolute inset-0 text-center w-full h-full text-5xl font-bold text-gray-900/10 break-words">
            <span class="py-16 block">Confidential</span>
            <span class="py-16 block">Not for publication</span>
            <span class="py-16 block">Downloaded by {{ user.email }}</span>
          </div>
        </div>
      {% /card %}
    {% else %}
      {% #card class="xl:col-start-5 xl:col-span-2 xl:row-start-1" %}
        <dl class="border-t border-slate-200 sm:divide-y sm:divide-slate-200">
          {% #description_item stacked=False title="Created at" %}
            {{ analysis_request.created_at }}
            <time datetime="{{ analysis_request.created_at|date:"Y-m-d H:i:sO" }}"></time>
          {% /description_item %}

          {% #description_item title="Created by" %}
            {% if user_can_view_staff_area %}
            {% link href=analysis_request.created_by.get_staff_url text=analysis_request.created_by.fullname %}
            {% else %}
            {{ analysis_request.created_by.fullname }}
            {% endif %}
          {% /description_item %}

          {% #description_item title="Purpose" %}
            {{ analysis_request.purpose }}
          {% /description_item %}
        </dl>
      {% /card %}
      {% #card class="overflow-hidden relative xl:col-span-4 xl:col-start-1 xl:row-start-1" %}
        <div class="text-center p-8 z-10 relative">
          {% icon_custom_spinner class="h-12 w-12 mb-4 mx-auto flex-1 animate-spin stroke-current stroke-2 text-slate-600" %}
          <h2 class="mt-2 mb-3 text-2xl font-bold text-slate-900">
            Your request is being processed
          </h2>
          <div class="grid gap-y-2 max-w-prose mx-auto">
            <p class="text-lg">
              You will be emailed when your report is ready.
            </p>
            <p>
              The results will be checked carefully by our team for privacy and
              security reasons.
            </p>
            <p>
              We aim to process requests within five working days. We are
              working to improve this for future requests.
            </p>
            <p class="text-slate-600 pt-4 mt-2 border-t border-slate-200">
              If you'd like any more information about requesting an analysis
              <span class="md:block">
                or have any questions,
                {% link href="mailto:team@opensafely.org" text="contact us" append_after="." %}
              </span>
            </p>
          </div>
        </div>
      {% /card %}
    {% endif %}
  </div>
</div>

<dialog id="downloadModal" class="max-w-prose p-8 shadow-xl rounded-md backdrop:bg-black/25 backdrop:backdrop-blur-sm">
  <section class="prose prose-blue">
    <h2 class="sr-only">Read and agree before downloading</h2>
    <p>
      You must abide by the
      <a
        href="https://www.opensafely.org/policies-for-researchers/#details-all-datasets"
        >OpenSAFELY policy</a
      > when sharing these results:
    </p>
    <p>
      This report can be shared IN CONFIDENCE and ONLY with key members of your team
      / collaborators (for the purpose of seeking feedback and contribution to
      inform the final paper or report), by a webinar or by email, but the following
      guidelines must be adhered to:
    </p>
    <ol>
      <li>
        Acceptable sharing examples include: the senior sponsor; analysts and senior
        manager in the NHS E department accountable for the specific policy
        activities being investigated (but NOT other departments); key members of
        the relevant
        <a
          href="https://www.gov.uk/government/publications/scientific-advisory-group-for-emergencies-sage-coronavirus-covid-19-response-membership/list-of-participants-of-sage-and-related-sub-groups"
          >scientific advisory groups</a
        >; established relevant expert collaborators.
      </li>
      <li>
        If sharing this report with individuals external to your immediate project
        team (e.g. key members of the relevant scientific advisory groups; relevant
        external expert collaborators) you must ensure the content being shared has
        been reviewed and approved by the senior sponsor and your line manager and
        <mark>provide your co-pilot with a copy of the content.</mark>
      </li>
      <li>
        All recipients must be reminded that the content is shared in confidence and
        they must not distribute it further (see
        <a
          href="https://www.opensafely.org/policies-for-researchers/#details-all-datasets"
          >publication guidelines</a
        >).
      </li>
    </ol>
    <p>
      If you are unsure that your planned sharing is appropriate, please contact
      your co-pilot in the first instance,or email
      <a href="mailto:publications@opensafely.org">publications@opensafely.org</a>.
    </p>
  </section>
  <div class="flex flex-row gap-2 mt-6">
    {% #button variant="primary" type="button" value="generating" disabled=True %}
      Generating PDF
    {% /button %}
    {% #button variant="primary" type="button" value="confirm" class="hidden" %}
      Agree and download
    {% /button %}
    {% #button variant="primary" type="button" value="downloading" disabled=True class="hidden" %}
      Downloading
    {% /button %}
    {% #button variant="secondary-outline" type="button" value="cancel" %}
      Cancel
    {% /button %}
  </div>
</dialog>
{% endblock content %}

{% block extra_js %}
  {% vite_asset "assets/src/scripts/analysis-request-detail.js" %}
{% endblock %}
